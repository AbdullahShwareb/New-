<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ”¥ğŸ”¥Ù…Ø­Ù„Ø§Øª Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ Ø§Ù„Ø´ÙˆØ§Ø±Ø¨Ù‹ Ù„Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©ğŸ”¥ğŸ”¥ â€” )</title>
<style>
:root{ --bg:#f7f7fb; --card:#fff; --txt:#111; --muted:#6b7280; --line:#e5e7eb; --pri:#2563eb; --ok:#16a34a; --warn:#b45309; }
*{ box-sizing:border-box; }
body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Kufi Arabic', Tahoma, Arial; background:var(--bg); color:var(--txt) }
.topbar{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--line); padding:.6rem .9rem; display:flex; align-items:center; justify-content:space-between; z-index:10 }
.brand{ font-weight:900 }
.actions{ display:flex; gap:.5rem; align-items:center }
.container{ padding:1rem }
.grid{ display:grid; gap:1rem; grid-template-columns: 1fr; }
@media(min-width:1000px){ .grid{ grid-template-columns: 340px 1fr; } }
.card{ background:var(--card); border:1px solid var(--line); border-radius:.8rem; padding:1rem; box-shadow:0 8px 20px rgba(0,0,0,.04) }
.card-head{ display:flex; align-items:center; justify-content:space-between }
.field{ margin:.6rem 0; display:flex; flex-direction:column; gap:.3rem }
.field input, .field select{ border:1px solid var(--line); border-radius:.5rem; padding:.55rem .7rem; outline:none }
.field input:focus, .field select:focus{ border-color:var(--pri) }
.stats{ display:grid; grid-template-columns:repeat(2,1fr); gap:.5rem; margin:.6rem 0 }
.stat{ background:#f8fafc; border:1px solid var(--line); border-radius:.6rem; padding:.8rem }
.muted{ color:var(--muted); font-size:.85rem }
.num::after{ content:" Ø´ÙŠÙ‚Ù„"; color:var(--muted); font-weight:500 }
.row-btns{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.4rem }
.btn{ border:1px solid var(--line); background:#fff; border-radius:.6rem; padding:.5rem .75rem; cursor:pointer }
.btn:hover{ background:#f3f4f6 }
.btn.primary{ background:var(--pri); color:#fff; border-color:transparent }
.btn.success{ background:var(--ok); color:#fff; border-color:transparent }
.btn.ghost{ background:#fff; color:#111 }
.input{ border:1px solid var(--line); border-radius:.5rem; padding:.5rem .7rem; }
.table-wrap{ max-height:380px; overflow:auto; border:1px solid var(--line); border-radius:.6rem }
.table{ width:100%; border-collapse:collapse }
.table th, .table td{ padding:.6rem .5rem; border-bottom:1px solid var(--line); text-align:right; vertical-align:middle }
.table small{ color:var(--muted) }
.week{ display:grid; grid-template-columns: repeat(2,1fr); gap:.5rem }
@media(min-width:900px){ .week{ grid-template-columns: repeat(3,1fr); } }
.day{ background:#fff; border:1px solid var(--line); border-radius:.6rem; padding:.5rem; min-height:84px }
.chip{ display:inline-flex; align-items:center; gap:.35rem; background:#e9f2ff; border:1px solid #cfe4ff; padding:.25rem .6rem; border-radius:50rem; margin:.25rem .25rem 0 0; font-size:.9rem }
.chip .x{ cursor:pointer; color:#b91c1c }
.small{ font-size:.9rem }
.grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:.5rem }
.grid-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:.5rem }
.pill{ background:#f8fafc; border:1px solid var(--line); border-radius:.6rem; padding:.8rem }
.mt{ margin-top:.8rem }
.toolbar{ display:flex; gap:.5rem; align-items:center; margin:.3rem 0 }
.tabs{ display:flex; gap:.4rem; border-bottom:1px solid var(--line); margin-bottom:.6rem }
.tab{ background:#fff; border:1px solid var(--line); border-bottom:none; border-radius:.6rem .6rem 0 0; padding:.4rem .7rem; cursor:pointer }
.tab.active{ background:#eef2ff; color:#1e40af }
.tabcontent{ display:none }
.tabcontent.show{ display:block }
.modal{ position:fixed; inset:0; display:none; align-items:center;  justify-content:center; background:rgba(0,0,0,.25); z-index:100 }
.modal.show{ display:flex }
.modal-box{ background:#fff; width:min(520px,92vw); border-radius:.8rem; padding:1rem; border:1px solid var(--line) }
.filelabel{ position:relative }
.filelabel input{ position:absolute; inset:0; opacity:0; cursor:pointer }
.warnline{ color:#b91c1c; font-size:.9rem; margin-top:.25rem }
</style>
</head>
<body>
<nav class="topbar">
  <div class="brand">ğŸ”¥Ù…Ø­Ù„Ø§Øª Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ Ø§Ù„Ø´ÙˆØ§Ø±Ø¨ Ù„Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©ğŸ”¥</div>
  <div class="actions">
    <button id="btnExport" class="btn ghost">ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
    <label class="btn ghost filelabel">Ø§Ø³ØªÙŠØ±Ø§Ø¯<input id="importFile" type="file" accept=".json" hidden></label>
  </div>
</nav>

<main class="container">
  <section class="grid">
    <div class="card">
      <h2>Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>

      <!-- âœ… changed label + empty-by-default select -->
      <div class="field">
        <label>Ø§Ù„Ø´Ø±ÙƒØ©</label>
        <select id="selSupplier"></select>
        <div id="selHint" class="warnline" style="display:none">Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ.</div>
      </div>

      <div class="stats">
        <div class="stat"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div><div id="sumInv" class="num">0</div></div>
        <div class="stat"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div><div id="sumPay" class="num">0</div></div>
        <div class="stat"><div class="muted">Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</div><div id="open" class="num">0</div></div>
        <div class="stat"><div class="muted">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div><div id="bal" class="num">0</div></div>
      </div>

      <div class="row-btns">
        <button id="addInvoice" class="btn primary">Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©</button>
        <button id="addPayment" class="btn success">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
        <button id="addSupplier" class="btn">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ©</button>
      </div>
      <hr>
      <div class="field"><label>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¨ØªØ§Ø±ÙŠØ®</label><input type="date" id="filterDate"></div>
      <div id="paymentsByDate" class="small"></div>
    </div>

    <div class="card">
      <div class="card-head"><h2>ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2><button id="addToCal" class="btn ghost">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</button></div>
      <div class="week">
        <div class="day"><div class="muted">Ø§Ù„Ø³Ø¨Øª</div><div id="d-sat"></div></div>
        <div class="day"><div class="muted">Ø§Ù„Ø£Ø­Ø¯</div><div id="d-sun"></div></div>
        <div class="day"><div class="muted">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</div><div id="d-mon"></div></div>
        <div class="day"><div class="muted">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</div><div id="d-tue"></div></div>
        <div class="day"><div class="muted">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</div><div id="d-wed"></div></div>
        <div class="day"><div class="muted">Ø§Ù„Ø®Ù…ÙŠØ³</div><div id="d-thu"></div></div>
        <div class="day"><div class="muted">Ø§Ù„Ø¬Ù…Ø¹Ø©</div><div id="d-fri"></div></div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-target="#tSup">Ø§Ù„Ø´Ø±ÙƒØ§Øª</button>
        <button class="tab" data-target="#tInv">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
        <button class="tab" data-target="#tPay">Ø§Ù„Ø¯ÙØ¹Ø§Øª</button>
        <button class="tab" data-target="#tRpt">ØªÙ‚Ø±ÙŠØ±</button>
      </div>

      <div class="tabcontent show" id="tSup">
        <div class="toolbar">
          <!-- âœ… search box kept and will filter; also used as "search above their names" -->
          <input id="supSearch" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©...">
          <button id="btnGlobalReport" class="btn ghost">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§ÙØªØªØ§Ø­ÙŠ</th><th>Ù…Ù†Ø¯ÙˆØ¨</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th></th></tr></thead>
            <tbody id="supBody"></tbody>
          </table>
        </div>
      </div>

      <div class="tabcontent" id="tInv">
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th></th></tr></thead>
            <tbody id="invBody"></tbody>
          </table>
        </div>
      </div>

      <div class="tabcontent" id="tPay">
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø·Ø±ÙŠÙ‚Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th></th></tr></thead>
            <tbody id="payBody"></tbody>
          </table>
        </div>
      </div>

      <div class="tabcontent" id="tRpt">
        <div class="grid-3">
          <div class="pill"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† (Ø£Ø±ØµØ¯Ø© Ù…ÙˆØ¬Ø¨Ø©)</div><div id="rDebt" class="num">0</div></div>
          <div class="pill"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div><div id="rPays" class="num">0</div></div>
          <div class="pill"><div class="muted">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</div><div id="rBal" class="num">0</div></div>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙˆØ§ØªÙŠØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯ÙØ¹Ø§Øª</th><th>Ø§ÙØªØªØ§Ø­ÙŠ</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th></tr></thead>
            <tbody id="rBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modals (Supplier / Invoice / Payment / Calendar / Global report) -->
<div class="modal" id="mSupplier"><div class="modal-box"><h3>Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©/ØªØ¹Ø¯ÙŠÙ„</h3>
<form id="fSup">
  <input type="hidden" id="sid">
  <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="sname" required></div>
  <div class="field"><label>Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ</label><input id="sopen" type="number" value="0"></div>
  <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label><input id="srep"></div>
  <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="snote"></div>
  <div class="row-btns"><button class="btn primary" type="submit">Ø­ÙØ¸</button><button class="btn" type="button" data-close="#mSupplier">Ø¥Ù„ØºØ§Ø¡</button></div>
</form></div></div>

<div class="modal" id="mInvoice"><div class="modal-box"><h3>Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©</h3>
<form id="fInv">
  <input type="hidden" id="iid">
  <div class="field"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="idate" type="date" required></div>
  <div class="field"><label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input id="ino"></div>
  <div class="field"><label>Ø§Ù„Ø´Ø±ÙƒØ©</label><select id="isup" required></select></div>
  <div class="field"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="iamt" type="number" step="0.01" min="0" required></div>
  <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="inote"></div>

  <div class="field">
    <label>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
    <input id="iimg" type="file" accept="image/*" capture="environment">
  </div>
  <div id="imgPreview" style="margin-top:.5rem"></div>
  <div class="row-btns"><button class="btn primary" type="submit">Ø­ÙØ¸</button><button class="btn" type="button" data-close="#mInvoice">Ø¥Ù„ØºØ§Ø¡</button></div>
</form></div></div>

<div class="modal" id="mPayment"><div class="modal-box"><h3>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</h3>
<form id="fPay">
  <input type="hidden" id="pid">
  <div class="field"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="pdate" type="date" required></div>
  <div class="field"><label>Ø§Ù„Ø´Ø±ÙƒØ©</label><select id="psup" required></select></div>
  <div class="field"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="pamt" type="number" step="0.01" min="0" required></div>
  <div class="field"><label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><input id="pmethod" placeholder="Ù†Ù‚Ø¯ÙŠ/ØªØ­ÙˆÙŠÙ„/Ø´ÙŠÙƒ"></div>
  <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label><input id="prep"></div>
  <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="pnote"></div>
  <div class="row-btns"><button class="btn success" type="submit">Ø­ÙØ¸</button><button class="btn" type="button" data-close="#mPayment">Ø¥Ù„ØºØ§Ø¡</button></div>
</form></div></div>

<div class="modal" id="mCalendar"><div class="modal-box"><h3>Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¥Ù„Ù‰ ÙŠÙˆÙ…</h3>
<form id="fCal">
  <div class="field"><label>Ø§Ù„Ø´Ø±ÙƒØ©</label><select id="calSup"></select></div>
  <div class="field"><label>Ø§Ù„ÙŠÙˆÙ…</label>
    <select id="calDay">
      <option value="sat">Ø§Ù„Ø³Ø¨Øª</option><option value="sun">Ø§Ù„Ø£Ø­Ø¯</option><option value="mon">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
      <option value="tue">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option value="wed">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="thu">Ø§Ù„Ø®Ù…ÙŠØ³</option><option value="fri">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
    </select>
  </div>
  <div class="row-btns"><button class="btn primary" type="submit">Ø¥Ø¶Ø§ÙØ©</button><button class="btn" type="button" data-close="#mCalendar">Ø¥ØºÙ„Ø§Ù‚</button></div>
</form></div></div>

<div class="modal" id="mGlobalReport"><div class="modal-box">
  <h3>ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</h3>
  <div class="grid-2">
    <div class="pill"><div class="muted">Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø±ØµØ¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª</div><div id="grTotalBalances" class="num">0</div></div>
    <div class="pill"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div><div id="grTotalPayments" class="num">0</div></div>
  </div>
  <h4 class="mt">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h4>
  <div class="table-wrap">
    <table class="table small">
      <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
      <tbody id="grPaymentsBody"></tbody>
    </table>
  </div>
  <div class="row-btns mt"><button class="btn" data-close="#mGlobalReport">Ø¥ØºÙ„Ø§Ù‚</button></div>
</div></div>

<script type="module">
// ===== Firebase Synced App (Firestore + Storage) =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, setDoc, deleteDoc,
  onSnapshot, query, where, getDocs, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject }
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

const firebaseConfig = {
  "apiKey": "AIzaSyDq5BPuKmFu4YVTOBkCdCnKhtOhAJK860Y",
  "authDomain": "abood-bf67f.firebaseapp.com",
  "projectId": "abood-bf67f",
  "storageBucket": "abood-bf67f.firebasestorage.app",
  "messagingSenderId": "80269306718",
  "appId": "1:80269306718:web:d8bb4cfe2d7781e8e4fdcf",
  "measurementId": "G-YT5BHZ37LL"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const $ = (s, root=document)=> root.querySelector(s);
const $$ = (s, root=document)=> [...root.querySelectorAll(s)];
const today = () => new Date().toISOString().slice(0,10);
const fmt = n => Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2});

let state = {
  suppliers: [],
  invoices: [],
  payments: [],
  week: {sat:[],sun:[],mon:[],tue:[],wed:[],thu:[],fri:[]}
};

const weekDocRef = doc(db, "meta", "week");

// ---------- UI ----------
function initTabs(){
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      $$('.tabcontent').forEach(c=>c.classList.remove('show'));
      $(btn.dataset.target).classList.add('show');
    });
  });
}
function openModal(id){ $(id).classList.add('show'); }
function closeModal(id){ $(id).classList.remove('show'); }
document.addEventListener('click', (e)=>{
  const closeSel = e.target.getAttribute('data-close');
  if(closeSel) closeModal(closeSel);
  if(e.target.classList.contains('modal')) e.target.classList.remove('show');
});

const byId = (a,id) => a.find(x=>x.id===id);

// âœ… normalize for better Arabic search
const norm = (s="") => String(s)
  .toLowerCase()
  .replace(/[Ø¥Ø£Ø¢Ø§]/g,'Ø§')
  .replace(/Ù‰/g,'ÙŠ')
  .replace(/Ø©/g,'Ù‡')
  .replace(/\s+/g,' ')
  .trim();

function refreshSupplierSelects(){
  const opts = state.suppliers
    .slice()
    .sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'ar'))
    .map(s=>`<option value="${s.id}">${s.name}</option>`).join('');

  // âœ… No default selected on load: placeholder always selected, real selection only when user chooses
  $('#selSupplier').innerHTML = `<option value="" selected>â€” Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© â€”</option>` + opts;

  $('#isup').innerHTML = `<option value="" disabled selected>Ø§Ø®ØªØ±...</option>` + opts;
  $('#psup').innerHTML = `<option value="" disabled selected>Ø§Ø®ØªØ±...</option>` + opts;
  $('#calSup').innerHTML = opts || `<option value="" disabled selected>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª</option>`;
}

const sumInv = (supplierId) => state.invoices
  .filter(x=>x.supplierId===supplierId)
  .reduce((a,b)=>a+Number(b.amount||0),0);

const sumPay = (supplierId) => state.payments
  .filter(x=>x.supplierId===supplierId)
  .reduce((a,b)=>a+Number(b.amount||0),0);

const balance = (supplierId) =>
  (byId(state.suppliers, supplierId)?.opening||0) + sumInv(supplierId) - sumPay(supplierId);

function setSummaryZeros(showHint=false){
  $('#sumInv').textContent = fmt(0);
  $('#sumPay').textContent = fmt(0);
  $('#open').textContent = fmt(0);
  $('#bal').textContent = fmt(0);
  $('#selHint').style.display = showHint ? 'block' : 'none';
}

function renderSummary(){
  const id = String($('#selSupplier').value || '');
  if(!id){
    setSummaryZeros(false);
    return;
  }
  const s = byId(state.suppliers, id);
  $('#selHint').style.display = 'none';
  $('#sumInv').textContent = fmt(sumInv(id));
  $('#sumPay').textContent = fmt(sumPay(id));
  $('#open').textContent = fmt(s?.opening||0);
  $('#bal').textContent = fmt(balance(id));
}

function renderSuppliers(){
  const qRaw = ($('#supSearch')?.value || '').trim();
  const q = norm(qRaw);
  const rows = q
    ? state.suppliers.filter(s=> norm(s.name||'').includes(q))
    : state.suppliers;

  const sorted = rows.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'ar'));
  $('#supBody').innerHTML = sorted.map((s,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${s.name}</td>
      <td>${fmt(s.opening||0)}</td>
      <td>${s.rep||''}</td>
      <td>${s.notes||''}</td>
      <td>
        <button class="btn" onclick="editSup('${s.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="delSup('${s.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>
  `).join('');
}

function renderInvoices(){
  const list = state.invoices.slice().sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  $('#invBody').innerHTML = list.map(x=>`
    <tr>
      <td>${x.date||''}</td>
      <td>${x.number||''}</td>
      <td>${byId(state.suppliers,x.supplierId)?.name||''}</td>
      <td>${fmt(x.amount)}</td>
      <td>
        ${x.note||''}
        ${x.imageUrl ? `<br><button class="btn ghost" onclick="viewImage('${x.imageUrl}')">ğŸ“· Ø¹Ø±Ø¶</button>` : ''}
      </td>
      <td><button class="btn" onclick="delInv('${x.id}')">Ø­Ø°Ù</button></td>
    </tr>
  `).join('');
}

function renderPayments(){
  const list = state.payments.slice().sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  $('#payBody').innerHTML = list.map(x=>`
    <tr>
      <td>${x.date||''}</td>
      <td>${byId(state.suppliers,x.supplierId)?.name||''}</td>
      <td>${x.rep||''}</td>
      <td>${fmt(x.amount)}</td>
      <td>${x.method||''}</td>
      <td>${x.note||''}</td>
      <td><button class="btn" onclick="delPay('${x.id}')">Ø­Ø°Ù</button></td>
    </tr>
  `).join('');
}

function renderReport(){
  const rows = state.suppliers.map(s=>{
    const inv = sumInv(s.id), pay = sumPay(s.id), bal = (s.opening||0)+inv-pay;
    return {name:s.name, inv, pay, open:s.opening||0, bal};
  }).sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'ar'));

  const debtTotal = rows.map(r=>r.bal).filter(x=>x>0).reduce((a,b)=>a+b,0);
  const payTotal = rows.map(r=>r.pay).reduce((a,b)=>a+b,0);
  const grandBal = rows.map(r=>r.bal).reduce((a,b)=>a+b,0);

  $('#rDebt').textContent = fmt(debtTotal);
  $('#rPays').textContent = fmt(payTotal);
  $('#rBal').textContent = fmt(grandBal);

  $('#rBody').innerHTML = rows.map(r=>`
    <tr>
      <td>${r.name}</td><td>${fmt(r.inv)}</td>
      <td>${fmt(r.pay)}</td><td>${fmt(r.open)}</td>
      <td>${fmt(r.bal)}</td>
    </tr>
  `).join('');
}

function renderCalendar(){
  const map = {sat:'#d-sat',sun:'#d-sun',mon:'#d-mon',tue:'#d-tue',wed:'#d-wed',thu:'#d-thu',fri:'#d-fri'};
  Object.entries(map).forEach(([k,sel])=>{
    const wrap = document.querySelector(sel);
    const arr = (state.week?.[k] || []);
    wrap.innerHTML = arr.map(id=>{
      const s = byId(state.suppliers, id);
      if(!s) return '';
      return `
        <span class="chip" title="Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ ${s.name}" onclick="openSupplier('${id}')">
          ${s.name}
          <span class="x" title="Ø­Ø°Ù Ù…Ù† Ø§Ù„ÙŠÙˆÙ…" onclick="event.stopPropagation(); removeFromDay('${k}', '${id}')">&times;</span>
        </span>`;
    }).join('');
  });
}

function renderPaymentsByDate(){
  const d = $('#filterDate').value;
  if(!d){ $('#paymentsByDate').innerHTML=''; return; }
  const list = state.payments.filter(x=>x.date===d);
  if(!list.length){ $('#paymentsByDate').innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</div>'; return; }
  const total = list.reduce((a,b)=>a+Number(b.amount||0),0);
  $('#paymentsByDate').innerHTML = list.map(x=>{
    const s=byId(state.suppliers,x.supplierId)?.name||'';
    return `<div>â€¢ <strong>${fmt(x.amount)}</strong> â€” ${s} â€” Ù…Ù†Ø¯ÙˆØ¨: ${x.rep||'-'} â€” ${x.method||''}</div>`;
  }).join('') + `<hr><div><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong> <span>${fmt(total)}</span></div>`;
}

function rerender(){
  refreshSupplierSelects();
  renderSummary();
  renderSuppliers();
  renderInvoices();
  renderPayments();
  renderReport();
  renderCalendar();
  renderPaymentsByDate();
}

// ---------- Firebase CRUD ----------
async function addOrUpdateSupplier(s){
  if(s.id){
    await setDoc(doc(db,"suppliers",s.id), {
      name: s.name, opening: Number(s.opening||0), rep: s.rep||'', notes: s.notes||''
    }, {merge:true});
  } else {
    await addDoc(collection(db,"suppliers"), {
      name: s.name, opening: Number(s.opening||0), rep: s.rep||'', notes: s.notes||''
    });
  }
}

async function deleteSupplierCascade(id){
  const invSnap = await getDocs(query(collection(db,"invoices"), where("supplierId","==",id)));
  for(const d of invSnap.docs){
    const data = d.data();
    if(data.storagePath){
      try { await deleteObject(sRef(storage, data.storagePath)); } catch {}
    }
    await deleteDoc(doc(db,"invoices",d.id));
  }
  const paySnap = await getDocs(query(collection(db,"payments"), where("supplierId","==",id)));
  for(const d of paySnap.docs){
    await deleteDoc(doc(db,"payments",d.id));
  }
  const wk = {...state.week};
  Object.keys(wk).forEach(k=> wk[k] = (wk[k]||[]).filter(v=>v!==id));
  await setDoc(weekDocRef, wk, {merge:false});
  await deleteDoc(doc(db,"suppliers",id));
}

async function addOrUpdateInvoice(it, file){
  let imageUrl = it.imageUrl || null;
  let storagePath = it.storagePath || null;

  if(file){
    const safeName = (file.name||"photo.jpg").replace(/[^a-zA-Z0-9._-]/g,'_');
    const path = `invoices/${Date.now()}_${safeName}`;
    const r = sRef(storage, path);
    await uploadBytes(r, file);
    imageUrl = await getDownloadURL(r);
    storagePath = path;

    if(it.storagePath && it.storagePath !== path){
      try { await deleteObject(sRef(storage, it.storagePath)); } catch {}
    }
  }

  const payload = {
    date: it.date || today(),
    number: it.number || '',
    supplierId: it.supplierId,
    amount: Number(it.amount||0),
    note: it.note || '',
    imageUrl,
    storagePath
  };

  if(it.id){
    await setDoc(doc(db,"invoices",it.id), payload, {merge:true});
  } else {
    await addDoc(collection(db,"invoices"), payload);
  }
}

async function deleteInvoiceDoc(id){
  const inv = byId(state.invoices, id);
  if(inv?.storagePath){
    try { await deleteObject(sRef(storage, inv.storagePath)); } catch {}
  }
  await deleteDoc(doc(db,"invoices",id));
}

async function addOrUpdatePayment(it){
  const payload = {
    date: it.date || today(),
    supplierId: it.supplierId,
    amount: Number(it.amount||0),
    method: it.method || '',
    rep: it.rep || '',
    note: it.note || ''
  };
  if(it.id){
    await setDoc(doc(db,"payments",it.id), payload, {merge:true});
  } else {
    await addDoc(collection(db,"payments"), payload);
  }
}

async function deletePaymentDoc(id){
  await deleteDoc(doc(db,"payments",id));
}

async function saveWeek(w){
  await setDoc(weekDocRef, w, {merge:false});
}

// ---------- expose ----------
window.editSup = (id)=>{
  const s = byId(state.suppliers,id);
  if(!s) return;
  $('#sid').value = s.id;
  $('#sname').value = s.name;
  $('#sopen').value = s.opening||0;
  $('#srep').value = s.rep||'';
  $('#snote').value = s.notes||'';
  openModal('#mSupplier');
};

// âœ… confirm on deletes (supplier/invoice/payment already had confirm; now calendar delete too)
window.delSup = async (id)=>{ if(confirm('Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© ÙˆÙƒÙ„ Ø­Ø±ÙƒØ§ØªÙ‡Ø§ØŸ')) await deleteSupplierCascade(id); };
window.delInv = async (id)=>{ if(confirm('Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) await deleteInvoiceDoc(id); };
window.delPay = async (id)=>{ if(confirm('Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) await deletePaymentDoc(id); };

window.removeFromDay = async (k,id)=>{
  const sName = byId(state.suppliers, id)?.name || 'Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©';
  if(!confirm(`Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù "${sName}" Ù…Ù† ÙŠÙˆÙ… ${k}ØŸ`)) return;
  const w = {...state.week};
  w[k] = (w[k]||[]).filter(v=>v!==id);
  await saveWeek(w);
};

window.openSupplier = (id)=>{
  $('#selSupplier').value = String(id);
  renderSummary();
  window.scrollTo({top:0, behavior:'smooth'});
};

window.viewImage = (src)=>{
  document.getElementById('fullImg').src = src;
  openModal('#mImage');
};

// ---------- submit handlers ----------
document.addEventListener('submit', async (e)=>{
  if(e.target.id==='fSup'){ e.preventDefault();
    const id = $('#sid').value ? String($('#sid').value) : null;
    const s = {
      id,
      name: $('#sname').value.trim(),
      opening: Number($('#sopen').value||0),
      rep: $('#srep').value.trim(),
      notes: $('#snote').value.trim()
    };
    await addOrUpdateSupplier(s);
    closeModal('#mSupplier'); e.target.reset();
  }

  if(e.target.id==='fInv'){ e.preventDefault();
    const id = $('#iid').value ? String($('#iid').value) : null;
    const fileInput = document.getElementById('iimg');
    const file = fileInput && fileInput.files ? fileInput.files[0] : null;
    const existing = id ? byId(state.invoices, id) : null;

    const it = {
      id,
      date: $('#idate').value || today(),
      number: $('#ino').value.trim(),
      supplierId: String($('#isup').value),
      amount: Number($('#iamt').value||0),
      note: $('#inote').value.trim(),
      imageUrl: existing?.imageUrl || null,
      storagePath: existing?.storagePath || null
    };
    await addOrUpdateInvoice(it, file);
    closeModal('#mInvoice'); e.target.reset();
    document.getElementById('imgPreview').innerHTML = '';
  }

  if(e.target.id==='fPay'){ e.preventDefault();
    const id = $('#pid').value ? String($('#pid').value) : null;
    const it = {
      id,
      date: $('#pdate').value || today(),
      supplierId: String($('#psup').value),
      amount: Number($('#pamt').value||0),
      method: $('#pmethod').value.trim(),
      rep: $('#prep').value.trim(),
      note: $('#pnote').value.trim()
    };
    await addOrUpdatePayment(it);
    closeModal('#mPayment'); e.target.reset();
  }

  if(e.target.id==='fCal'){ e.preventDefault();
    const id = String($('#calSup').value || '');
    const day = $('#calDay').value;
    if(!id) return;
    const w = {...state.week};
    w[day] = Array.from(new Set([...(w[day]||[]), id]));
    await saveWeek(w);
    closeModal('#mCalendar');
  }
});

// ---------- buttons ----------
document.getElementById('addSupplier').addEventListener('click', ()=> openModal('#mSupplier'));
document.getElementById('addInvoice').addEventListener('click', ()=> {
  document.getElementById('idate').value=today();
  document.getElementById('iid').value='';
  document.getElementById('imgPreview').innerHTML='';
  openModal('#mInvoice');
});
document.getElementById('addPayment').addEventListener('click', ()=> {
  document.getElementById('pdate').value=today();
  document.getElementById('pid').value='';
  openModal('#mPayment');
});
document.getElementById('addToCal').addEventListener('click', ()=> openModal('#mCalendar'));
document.getElementById('btnGlobalReport').addEventListener('click', ()=> {
  renderGlobalReport();
  openModal('#mGlobalReport');
});
document.getElementById('filterDate').addEventListener('change', renderPaymentsByDate);
document.getElementById('supSearch').addEventListener('input', renderSuppliers);

// âœ… when user selects company, update summary
document.getElementById('selSupplier').addEventListener('change', ()=>{
  const id = String($('#selSupplier').value || '');
  if(!id) setSummaryZeros(true);
  renderSummary();
});

// image preview
const _iimg = document.getElementById('iimg');
if(_iimg){
  _iimg.addEventListener('change', (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file){ document.getElementById('imgPreview').innerHTML = ''; return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      document.getElementById('imgPreview').innerHTML =
        `<img src="${reader.result}" style="max-width:120px;border-radius:.4rem">`;
    };
    reader.readAsDataURL(file);
  });
}

// Export / Import
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ayman-firebase-backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = async ()=>{
    try{
      const data = JSON.parse(r.result);

      if(Array.isArray(data.suppliers)){
        for(const s of data.suppliers){
          await addOrUpdateSupplier({id:s.id||null, name:s.name||'', opening:s.opening||0, rep:s.rep||'', notes:s.notes||''});
        }
      }
      if(Array.isArray(data.payments)){
        for(const p of data.payments){
          await addOrUpdatePayment({id:null, date:p.date||today(), supplierId:String(p.supplierId), amount:p.amount||0, method:p.method||'', rep:p.rep||'', note:p.note||''});
        }
      }
      if(Array.isArray(data.invoices)){
        for(const i of data.invoices){
          await addOrUpdateInvoice({id:null, date:i.date||today(), number:i.number||'', supplierId:String(i.supplierId), amount:i.amount||0, note:i.note||'', imageUrl:i.imageUrl||null, storagePath:i.storagePath||null}, null);
        }
      }
      if(data.week){
        await saveWeek(data.week);
      }

      alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø¥Ø¶Ø§ÙØ©) Ø¨Ù†Ø¬Ø§Ø­.');
    }catch(err){
      console.log(err);
      alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
    }
  };
  r.readAsText(f);
});

function renderGlobalReport(){
  const sumBalances = state.suppliers.map(s=> (s.opening||0) + sumInv(s.id) - sumPay(s.id)).reduce((a,b)=>a+b,0);
  document.getElementById('grTotalBalances').textContent = fmt(sumBalances);

  const totalPays = state.payments.reduce((a,b)=>a+Number(b.amount||0),0);
  document.getElementById('grTotalPayments').textContent = fmt(totalPays);

  const list = state.payments.slice().sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  document.getElementById('grPaymentsBody').innerHTML = list.map(x=>{
    const s=byId(state.suppliers,x.supplierId)?.name||'';
    return `<tr><td>${x.date}</td><td>${s}</td><td>${x.rep||''}</td><td>${x.method||''}</td><td>${fmt(x.amount)}</td><td>${x.note||''}</td></tr>`;
  }).join('');
}

// ---------- realtime ----------
function attachRealtime(){
  onSnapshot(collection(db,"suppliers"), (snap)=>{
    state.suppliers = snap.docs.map(d=>({id:d.id, ...d.data()}));

    // âœ… keep summary empty on load (do NOT auto-select first supplier)
    // if user had selected something earlier in the session, keep it if still exists
    const cur = String($('#selSupplier').value || '');
    if(cur && !state.suppliers.some(s=>s.id===cur)){
      $('#selSupplier').value = '';
      setSummaryZeros(false);
    }

    rerender();
  });

  onSnapshot(query(collection(db,"invoices"), orderBy("date","desc")), (snap)=>{
    state.invoices = snap.docs.map(d=>({id:d.id, ...d.data()}));
    rerender();
  });

  onSnapshot(query(collection(db,"payments"), orderBy("date","desc")), (snap)=>{
    state.payments = snap.docs.map(d=>({id:d.id, ...d.data()}));
    rerender();
  });

  onSnapshot(weekDocRef, (snap)=>{
    if(snap.exists()){
      state.week = {...state.week, ...snap.data()};
    }
    rerender();
  });
}

function init(){
  initTabs();
  document.getElementById('idate').value = today();
  document.getElementById('pdate').value = today();

  // âœ… start with empty company selection + zeros
  document.getElementById('selSupplier').value = '';
  setSummaryZeros(false);

  attachRealtime();
  rerender();
}
init();
</script>

<div class="modal" id="mImage">
  <div class="modal-box" style="max-width:90vw">
    <h3>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
    <img id="fullImg" style="width:100%;border-radius:.5rem">
    <div class="row-btns mt">
      <button class="btn" data-close="#mImage">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

</body>
</html>
